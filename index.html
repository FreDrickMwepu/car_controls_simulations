<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js'></script>
    <title>Car Controls</title>
</head>

<body>
    <div class="flex justify-center">
        <div class="container mx-auto p-4">
            <h1 class="text-center text-2xl font-bold mb-4">Car Controls</h1>
            <h1 class="text-large font-bold mb-2"> Quick Action Buttons </h1>
            <div class="grid grid-cols-2 gap-2">
                <button id="startStopButton"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Start
                </button>
                <script>
                    const startStopButton = document.getElementById("startStopButton");
                    startStopButton.addEventListener("click", function () {
                        if (startStopButton.innerText === "Start") {
                            startStopButton.innerText = "Stop";
                        } else {
                            startStopButton.innerText = "Start";
                        }
                    });
                </script>
                <button class="rounded bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4" id="forwardButton">
                    Hazards
                </button>
                <button class="rounded bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4" id="forwardButton">
                    Forward
                </button>
                <button class="rounded bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4" id="forwardButton">
                    Backward
                </button>
                <button class="rounded bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4">
                    Left Indicator
                </button>
                <button class="rounded bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4">
                    Right Indicator
                </button>
            </div>
            <h1 class="text-large font-bold mt-4 mb-2"> Quick Action Buttons </h1>
            <div class="grid grid-cols-3 gap-2 mt-4 flex justify-center">
                <div>
                    <h2 class="text-lg font-bold">Temperature</h2>
                    <p id="temperature"><span id="temperature_reading"> </span></p>
                    <script>
                        var socket = io();

                        socket.on('data', function (data) {
                            console.log(data);
                            document.getElementById('temperature_reading').innerHTML = data;
                        });
                    </script>
                </div>
                <div>
                    <h2 class="text-lg font-bold">Humidity</h2>
                    <p id="ultrasonic"><span id="ultrasonic_reading"> </span></p>
                    <script>
                        var socket = io();

                        socket.on('data', function (data) {
                            console.log(data);
                            document.getElementById('ultrasonic_reading').innerHTML = data;
                        });
                    </script>
                </div>
                <div>
                    <h2 class="text-lg font-bold">Light Intensity</h2>
                    <p id="battery">--</p>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2 mt-4 flex justify-center">
                <div>
                    <h2 class="text-lg font-bold">Ultrasonic Reading </h2>
                    <p id="ultrasonic"><span id="ultrasonic_reading"> </span></p>
                    <script>
                        var socket = io();

                        socket.on('data', function (data) {
                            console.log(data);
                            document.getElementById('ultrasonic_reading').innerHTML = data;
                        });
                    </script>
                </div>
                <div>
                    <h2 class="text-lg font-bold">Speed</h2>
                    <p id="speed">--</p>
                </div>
                <div>
                    <h2 class="text-lg font-bold">Battery Percentage</h2>
                    <p id="battery">--</p>
                </div>
            </div>
            <h1 class="text-large font-bold mt-4 mb-2"> Joystick Controls </h1>
            <div class="grid grid-cols-2 gap-2 mt-4 flex justify-center">
                <div>
                    <!-- Heading -->
                    <h1 style="text-align:center">
                        MOUSEBOT </h1>
                    <!-- Coordinates, Speed, and Angle -->
                    <p style="text-align: center;">
                        X: <span id="x_coordinate"> </span>
                        Y: <span id="y_coordinate"> </span>
                        Speed: <span id="speed"> </span> %
                        Angle: <span id="angle"> </span>
                    </p>
                    <!-- Canvas for drawing -->
                    <canvas id="canvas" name="game"></canvas>
                    <!-- WebSocket connection to Arduino server -->
                    <script>
                        // Create a WebSocket connection to the Arduino server
                        var connection = new WebSocket('ws://' + "192.168.4.1" + ':81/', ['arduino']);
                
                        // Event handler for when the connection is successfully opened
                        connection.onopen = function () {
                            connection.send('Connect ' + new Date());
                        };
                
                        // Event handler for any errors that occur during the connection
                        connection.onerror = function (error) {
                            console.log('WebSocket Error ', error);
                            alert('WebSocket Error ', error);
                        };
                
                        // Event handler for receiving messages from the server
                        connection.onmessage = function (e) {
                            console.log('Server: ', e.data);
                        };
                
                        // Function to send data to the server
                        function send(x, y, speed, angle) {
                            var data = {"x": x, "y": y, "speed": speed, "angle": angle};
                            data = JSON.stringify(data);
                            console.log(data);
                            connection.send(data);
                        }
                    </script>
                    <!-- Joystick functionality -->
                    <script>
                        var canvas, ctx;
                
                        window.addEventListener('load', () => {
                
                            canvas = document.getElementById('canvas');
                            ctx = canvas.getContext('2d');          
                            resize(); 
                
                            document.addEventListener('mousedown', startDrawing);
                            document.addEventListener('mouseup', stopDrawing);
                            document.addEventListener('mousemove', Draw);
                
                            document.addEventListener('touchstart', startDrawing);
                            document.addEventListener('touchend', stopDrawing);
                            document.addEventListener('touchcancel', stopDrawing);
                            document.addEventListener('touchmove', Draw);
                            window.addEventListener('resize', resize);
                
                            // Initialize coordinate and display values
                            document.getElementById("x_coordinate").innerText = 0;
                            document.getElementById("y_coordinate").innerText = 0;
                            document.getElementById("speed").innerText = 0;
                            document.getElementById("angle").innerText = 0;
                        });
                
                        // Resize the canvas and draw the background and joystick
                        var width, height, radius, x_orig, y_orig;
                        function resize() {
                            width = window.innerWidth;
                            radius = 100;
                            height = radius * 6.5;
                            ctx.canvas.width = width;
                            ctx.canvas.height = height;
                            background();
                            joystick(width / 2, height / 3);
                        }
                
                        // Draw the background circle
                        function background() {
                            x_orig = width / 2;
                            y_orig = height / 3;
                
                            ctx.beginPath();
                            ctx.arc(x_orig, y_orig, radius + 20, 0, Math.PI * 2, true);
                            ctx.fillStyle = '#ECE5E5';
                            ctx.fill();
                        }
                
                        // Draw the joystick circle
                        function joystick(width, height) {
                            ctx.beginPath();
                            ctx.arc(width, height, radius, 0, Math.PI * 2, true);
                            ctx.fillStyle = '#F08080';
                            ctx.fill();
                            ctx.strokeStyle = '#F6ABAB';
                            ctx.lineWidth = 8;
                            ctx.stroke();
                        }
                
                        // Get the position of the mouse or touch event
                        let coord = { x: 0, y: 0 };
                        let paint = false;
                        function getPosition(event) {
                            var mouse_x = event.clientX || event.touches[0].clientX;
                            var mouse_y = event.clientY || event.touches[0].clientY;
                            coord.x = mouse_x - canvas.offsetLeft;
                            coord.y = mouse_y - canvas.offsetTop;
                        }
                
                        // Check if the position is inside the joystick circle
                        function is_it_in_the_circle() {
                            var current_radius = Math.sqrt(Math.pow(coord.x - x_orig, 2) + Math.pow(coord.y - y_orig, 2));
                            if (radius >= current_radius) return true
                            else return false
                        }
                
                        // Start drawing when mouse or touch event begins
                        function startDrawing(event) {
                            paint = true;
                            getPosition(event);
                            if (is_it_in_the_circle()) {
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                background();
                                joystick(coord.x, coord.y);
                                Draw();
                            }
                        }
                
                        // Stop drawing when mouse or touch event ends
                        function stopDrawing() {
                            paint = false;
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            background();
                            joystick(width / 2, height / 3);
                            document.getElementById("x_coordinate").innerText = 0;
                            document.getElementById("y_coordinate").innerText = 0;
                            document.getElementById("speed").innerText = 0;
                            document.getElementById("angle").innerText = 0;
                        }
                
                        // Draw the joystick and calculate values when mouse or touch event occurs
                        function Draw(event) {
                            if (paint) {
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                background();
                                var angle_in_degrees,x, y, speed;
                                var angle = Math.atan2((coord.y - y_orig), (coord.x - x_orig));
                
                                if (Math.sign(angle) == -1) {
                                    angle_in_degrees = Math.round(-angle * 180 / Math.PI);
                                }
                                else {
                                    angle_in_degrees =Math.round( 360 - angle * 180 / Math.PI);
                                }
                
                                if (is_it_in_the_circle()) {
                                    joystick(coord.x, coord.y);
                                    x = coord.x;
                                    y = coord.y;
                                }
                                else {
                                    x = radius * Math.cos(angle) + x_orig;
                                    y = radius * Math.sin(angle) + y_orig;
                                    joystick(x, y);
                                }
                
                                getPosition(event);
                
                                var speed =  Math.round(100 * Math.sqrt(Math.pow(x - x_orig, 2) + Math.pow(y - y_orig, 2)) / radius);
                
                                var x_relative = Math.round(x - x_orig);
                                var y_relative = Math.round(y - y_orig);
                                
                                // Update coordinate and display values
                                document.getElementById("x_coordinate").innerText =  x_relative;
                                document.getElementById("y_coordinate").innerText =y_relative ;
                                document.getElementById("speed").innerText = speed;
                                document.getElementById("angle").innerText = angle_in_degrees;
                
                                // Send data to the server
                                send( x_relative,y_relative,speed,angle_in_degrees);
                            }
                        } 
                    </script>
                </div
            </div>
        </div>
    </div>
</body>

</html>